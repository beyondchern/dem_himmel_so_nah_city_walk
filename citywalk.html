<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>City Walk</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    /* GPS Button */
    #gpsBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 900;
      padding: 12px 16px;
      border-radius: 24px;
      border: none;
      background: #000;
      color: #fff;
      font-size: 14px;
    }

    /* Overlay */
    #overlay {
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 1000;
      display: none;
      overflow-y: auto;
      padding: 16px;
    }

    #overlay.active {
      display: block;
    }

    .close-btn {
      position: sticky;
      top: 0;
      width: 100%;
      background: #000;
      color: #fff;
      border: none;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
    }

    .lang-switch {
      margin: 12px 0;
      text-align: right;
    }

    .lang-switch button {
      padding: 6px 10px;
      margin-left: 6px;
    }

    .content img {
      width: 100%;
      border-radius: 8px;
      margin: 12px 0;
    }

    audio {
      width: 100%;
      margin-top: 12px;
    }

    hr {
      margin: 20px 0;
    }
  </style>
</head>
<body>

<button id="gpsBtn">üìç Where am I?</button>
<div id="map"></div>

<!-- Fullscreen overlay -->
<div id="overlay">
  <button class="close-btn" onclick="closeOverlay()">‚Üê Back to map</button>

  <div class="lang-switch">
    Language:
    <button onclick="setLang('de')">DE</button>
    <button onclick="setLang('en')">EN</button>
  </div>

  <div class="content" id="overlayContent"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  /* ---------------- SETTINGS ---------------- */
  let currentLang = 'de';
  let currentPlace = null;
  let userMarker = null;
  let placesData = null;

  /* ---------------- MAP ---------------- */
  const map = L.map('map').setView([50.9787, 11.0328], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  /* ---------------- ICONS ---------------- */
  const imageIcon = L.icon({
    iconUrl: 'icons/image-pin.png',
    iconSize: [36, 36],
    iconAnchor: [18, 36]
  });

  const audioIcon = L.icon({
    iconUrl: 'icons/audio-pin.png',
    iconSize: [36, 36],
    iconAnchor: [18, 36]
  });

  /* ---------------- LOAD JSON ---------------- */
  fetch('places.json')
    .then(response => {
      if (!response.ok) throw new Error("places.json could not be loaded");
      return response.json();
    })
    .then(data => {
      placesData = data;
      if (data.settings?.default_language) currentLang = data.settings.default_language;
      initMapFromJSON(data);
    })
    .catch(error => {
      console.error(error);
      alert("Content could not be loaded.");
    });

  /* ---------------- INIT MARKERS FROM JSON ---------------- */
  function initMapFromJSON(data) {
    data.stations.forEach(station => {
      const icon = station.type === "audio" ? audioIcon : imageIcon;

      L.marker(
        [station.coordinates.lat, station.coordinates.lng],
        { icon }
      )
        .addTo(map)
        .on('click', () => openOverlay(station));
    });
  }

  /* ---------------- OVERLAY ---------------- */
  function openOverlay(station) {
    currentPlace = station;
    renderContent();
    document.getElementById('overlay').classList.add('active');
  }

  function closeOverlay() {
    document.getElementById('overlay').classList.remove('active');
  }

  function setLang(lang) {
    currentLang = lang;
    if (currentPlace) renderContent();
  }

  function renderContent() {
    const s = currentPlace;

    let html = `
      <h2>${s.title[currentLang]}</h2>
      <p><em>${s.short_intro[currentLang]}</em></p>
    `;

    /* MEDIA */
    if (s.type === "image" && s.media?.image) {
      html += `<img src="${s.media.image}" alt="">`;

      if (s.media.caption) {
        html += `<p><small>${s.media.caption[currentLang]}</small></p>`;
      }
    }

    if (s.type === "audio" && s.media?.audio) {
      html += `
        <audio controls>
          <source src="${s.media.audio}" type="audio/mpeg">
        </audio>
      `;
      if (s.media.duration) {
        html += `<p><small>Dauer: ${s.media.duration}</small></p>`;
      }
    }

    /* CURATORIAL TEXT */
    if (s.curatorial_text) {
      html += `<hr><p>${s.curatorial_text[currentLang]}</p>`;
    }

    /* EDUCATIONAL PROMPT */
    if (s.educational_prompt) {
      html += `<hr><h3>üß† Denkimpuls</h3><p>${s.educational_prompt[currentLang]}</p>`;
    }

    /* FURTHER THOUGHT */
    if (s.further_thought) {
      html += `<p><em>${s.further_thought[currentLang]}</em></p>`;
    }

    document.getElementById('overlayContent').innerHTML = html;
  }

  /* ---------------- GPS ---------------- */
  document.getElementById('gpsBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert("Geolocation not supported.");
      return;
    }

    navigator.geolocation.watchPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];

      if (!userMarker) {
        userMarker = L.circleMarker(latlng, {
          radius: 8,
          color: "#0066ff",
          fillColor: "#0066ff",
          fillOpacity: 0.8
        }).addTo(map);
      } else {
        userMarker.setLatLng(latlng);
      }

      map.setView(latlng, 16);
    });
  });

  /* ---------------- SERVICE WORKER ---------------- */
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

</body>
</html>
